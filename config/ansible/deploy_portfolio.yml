- name: Deploy portfolio (root does all; chown to app at end)
  hosts: web
  become: true
  gather_facts: true
  vars:
    repo_url: "{{ lookup('env','REPO_URL') }}"
    app_user: app
    app_dir: /opt/portfolio
    venv_dir: /opt/portfolio/venv
    gunicorn_bind: "127.0.0.1:8000"
    service_name: portfolio
    python_pkg: python3
    pip_pkg: python3-pip
    git_pkg: git
    app_module: "{{ lookup('env','APP_MODULE') | default('app:app', true) }}"

  pre_tasks:
    - name: Sanity check repo_url
      ansible.builtin.assert:
        that: repo_url is match("^(git@|https://).*")
        fail_msg: "Set REPO_URL env var to your Git repo (HTTPS or SSH)."

  tasks:
    - name: Ensure base packages
      ansible.builtin.package:
        name: [ "{{ python_pkg }}", "{{ pip_pkg }}", "{{ git_pkg }}", nginx ]
        state: present

    - name: Ensure app user exists
      ansible.builtin.user:
        name: "{{ app_user }}"
        create_home: yes
        shell: /bin/bash

    - name: Create app directory (root-owned initially)
      ansible.builtin.file:
        path: "{{ app_dir }}"
        state: directory
        mode: "0755"

    - name: If repo exists, pull; else clone fresh
      ansible.builtin.shell: |
        set -e
        if [ -d "{{ app_dir }}/.git" ]; then
          cd "{{ app_dir }}"
          git config --global --add safe.directory "{{ app_dir }}" || true
          git fetch --all --prune
          git reset --hard origin/HEAD || git reset --hard HEAD
        else
          rm -rf "{{ app_dir }}/*" "{{ app_dir }}/.??*" || true
          git config --global --add safe.directory "{{ app_dir }}" || true
          git clone "{{ repo_url }}" "{{ app_dir }}"
        fi
      args:
        executable: /bin/bash

    - name: Detect Flask markers
      ansible.builtin.stat:
        path: "{{ item }}"
      register: flask_markers
      loop:
        - "{{ app_dir }}/requirements.txt"
        - "{{ app_dir }}/app.py"
        - "{{ app_dir }}/wsgi.py"

    - name: Decide if Flask deploy
      ansible.builtin.set_fact:
        is_flask: "{{ (flask_markers.results | selectattr('stat.exists') | list | length) > 0 }}"

    - name: Create venv (Flask only, root)
      when: is_flask
      ansible.builtin.command: "{{ python_pkg }} -m venv {{ venv_dir }}"
      args:
        creates: "{{ venv_dir }}/bin/activate"

    - name: Upgrade pip/setuptools/wheel (Flask)
      when: is_flask
      ansible.builtin.shell: "{{ venv_dir }}/bin/pip install --upgrade pip setuptools wheel"

    - name: Install requirements (Flask)
      when: is_flask
      ansible.builtin.shell: |
        set -e
        cd "{{ app_dir }}"
        if [ -f requirements.txt ]; then
          {{ venv_dir }}/bin/pip install -r requirements.txt
        else
          {{ venv_dir }}/bin/pip install flask gunicorn
        fi
      args:
        executable: /bin/bash

    - name: Create systemd service for Gunicorn (Flask)
      when: is_flask
      ansible.builtin.copy:
        dest: "/etc/systemd/system/{{ service_name }}.service"
        mode: "0644"
        content: |
          [Unit]
          Description=Gunicorn for {{ service_name }}
          After=network.target

          [Service]
          User={{ app_user }}
          Group={{ app_user }}
          WorkingDirectory={{ app_dir }}
          Environment="PATH={{ venv_dir }}/bin"
          ExecStart={{ venv_dir }}/bin/gunicorn --bind {{ gunicorn_bind }} {{ app_module }}
          Restart=always
          RestartSec=5

          [Install]
          WantedBy=multi-user.target

    - name: Reload & start service (Flask)
      when: is_flask
      ansible.builtin.systemd:
        name: "{{ service_name }}"
        daemon_reload: yes
        state: restarted
        enabled: yes

    - name: Nginx config (proxy if Flask, static if not)
      ansible.builtin.copy:
        dest: /etc/nginx/conf.d/portfolio.conf
        mode: "0644"
        content: |
          server {
            listen 80 default_server;
            server_name _;
            client_max_body_size 20m;

            {% if is_flask %}
            location / {
              proxy_pass http://{{ gunicorn_bind }};
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
            }
            {% else %}
            root {{ app_dir }};
            index index.html index.htm;
            location / {
              try_files $uri $uri/ =404;
            }
            {% endif %}
          }

    - name: Test Nginx config
      ansible.builtin.command: nginx -t
      register: nginx_test
      changed_when: false

    - name: Show Nginx test
      ansible.builtin.debug:
        var: nginx_test.stdout_lines

    - name: Reload Nginx
      ansible.builtin.service:
        name: nginx
        state: reloaded
        enabled: yes

    - name: Chown tree to app user at end
      ansible.builtin.file:
        path: "{{ app_dir }}"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        recurse: yes

    - name: Health check (Flask socket)
      when: is_flask
      ansible.builtin.shell: "curl -fsS http://{{ gunicorn_bind }} | head -c 200 || true"
      register: hc_local
      changed_when: false

    - name: Health check via Nginx
      ansible.builtin.uri:
        url: "http://127.0.0.1/"
        return_content: true
      register: hc_http
      failed_when: false

    - name: Show HTTP head
      ansible.builtin.debug:
        msg: |
          Flask? {{ is_flask }}
          HTTP head:
          {{ (hc_http.content | default(''))[:200] }}
