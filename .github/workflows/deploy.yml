---
- name: Deploy Flask portfolio on EC2 (Gunicorn + Nginx)
  hosts: web
  gather_facts: no  # Don't gather facts immediately
  become: yes

  tasks:
    # === Wait for SSH to be available ===
    - name: Wait for SSH connection to be available
      wait_for_connection:
        connect_timeout: 20
        sleep: 5
        delay: 5
        timeout: 300
      register: ssh_wait
      retries: 3
      delay: 10
      until: ssh_wait is success

    # === Now gather facts ===
    - name: Gather facts
      setup:

    - name: Display connection info
      debug:
        msg: "Successfully connected to {{ inventory_hostname }}"

    # === Update system ===
    - name: Update all packages (Amazon Linux 2)
      yum:
        name: '*'
        state: latest
        update_cache: yes
      when: ansible_distribution == "Amazon"

    # === Install dependencies ===
    - name: Install Python 3, pip, git, and development tools
      yum:
        name:
          - python3
          - python3-pip
          - git
          - python3-devel
          - gcc
        state: present

    # === Install Nginx ===
    - name: Install Nginx
      amazon.aws.ec2_instance:
        state: present
      ignore_errors: yes  # Fallback if amazon.aws collection not available
      
    - name: Install Nginx (fallback)
      yum:
        name: nginx
        state: present
        enablerepo: nginx

    # === Clone repository ===
    - name: Clone Flask application from GitHub
      git:
        repo: "{{ repo_url }}"
        dest: /home/ec2-user/portfolio-app
        version: main
        force: yes
      become: no

    # === Install Python dependencies ===
    - name: Install Python dependencies from requirements.txt
      pip:
        requirements: /home/ec2-user/portfolio-app/requirements.txt
        executable: pip3
      become: no

    # === Configure Gunicorn ===
    - name: Create Gunicorn systemd service
      template:
        src: templates/gunicorn.service.j2
        dest: /etc/systemd/system/gunicorn.service
      notify: Restart Gunicorn

    # === Configure Nginx ===
    - name: Configure Nginx
      template:
        src: templates/nginx.conf.j2
        dest: /etc/nginx/conf.d/portfolio.conf
      notify: Restart Nginx

    - name: Remove default Nginx config
      file:
        path: /etc/nginx/conf.d/default.conf
        state: absent
      notify: Restart Nginx

    # === Start services ===
    - name: Enable and start Gunicorn
      systemd:
        name: gunicorn
        state: started
        enabled: yes
        daemon_reload: yes

    - name: Enable and start Nginx
      systemd:
        name: nginx
        state: started
        enabled: yes

  handlers:
    - name: Restart Gunicorn
      systemd:
        name: gunicorn
        state: restarted
        daemon_reload: yes

    - name: Restart Nginx
      systemd:
        name: nginx
        state: restarted
