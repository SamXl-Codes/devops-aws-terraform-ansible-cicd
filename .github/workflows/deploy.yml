name: Deploy Portfolio App

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible + AWS CLI
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core==2.16.* awscli

      # ──────── SECRET VALIDATION ────────
      - name: Validate all secrets exist
        run: |
          set -e
          echo "Checking required secrets..."
          test -n "${{ secrets.AWS_ACCESS_KEY_ID }}"     || (echo "AWS_ACCESS_KEY_ID missing"     && exit 1)
          test -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}" || (echo "AWS_SECRET_ACCESS_KEY missing" && exit 1)
          test -n "${{ secrets.SSH_PRIVATE_KEY }}"       || (echo "SSH_PRIVATE_KEY missing"       && exit 1)
          test -n "${{ secrets.EC2_HOST }}"              || (echo "EC2_HOST missing"              && exit 1)
          test -n "${{ secrets.SECURITY_GROUP_ID }}"     || (echo "SECURITY_GROUP_ID missing"     && exit 1)
          test -n "${{ secrets.PUBLIC_KEY_BASE64 }}"     || (echo "PUBLIC_KEY_BASE64 missing"     && exit 1)
          echo "All secrets are present!"

      # ──────── TERRAFORM ────────
      - name: Terraform Init
        working-directory: infra/terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          TF_VAR_security_group_id: ${{ secrets.SECURITY_GROUP_ID }}
          TF_VAR_public_key_base64: ${{ secrets.PUBLIC_KEY_BASE64 }}
        run: terraform init -backend=false

      - name: Terraform Plan
        working-directory: infra/terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          TF_VAR_security_group_id: ${{ secrets.SECURITY_GROUP_ID }}
          TF_VAR_public_key_base64: ${{ secrets.PUBLIC_KEY_BASE64 }}
        run: terraform plan -out=plan.tfout

      - name: Terraform Apply
        working-directory: infra/terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          TF_VAR_security_group_id: ${{ secrets.SECURITY_GROUP_ID }}
          TF_VAR_public_key_base64: ${{ secrets.PUBLIC_KEY_BASE64 }}
        run: terraform apply -auto-approve plan.tfout

      # ──────── ANSIBLE DEPLOY ────────
      - name: Deploy with Ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: False
        run: |
          # Create SSH key
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > key.pem
          chmod 400 key.pem

          # Debug (you will see this in logs)
          echo "SSH key written ($(wc -l < key.pem) lines)"

          # Create inventory
          cat > inventory.ini <<EOF
          [web]
          ${{ secrets.EC2_HOST }} ansible_user=ec2-user ansible_ssh_private_key_file=$(pwd)/key.pem ansible_become=true ansible_remote_tmp=/tmp/.ansible/tmp
          EOF

          # Run playbook
          ansible-playbook -i inventory.ini config/ansible/deploy_portfolio_flask.yml --ssh-common-args="-o StrictHostKeyChecking=no"

          # Cleanup
          rm -f key.pem inventory.ini

      - name: Final cleanup
        if: always()
        run: rm -f key.pem inventory.ini
