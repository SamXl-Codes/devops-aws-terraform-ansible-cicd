name: Deploy Portfolio App
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0
          terraform_wrapper: false  # CRITICAL: This allows us to get outputs

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible + AWS CLI
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core==2.16.* awscli

      # ──────── SECRET VALIDATION ────────
      - name: Validate all secrets exist
        run: |
          set -e
          echo "Checking required secrets..."
          test -n "${{ secrets.AWS_ACCESS_KEY_ID }}" || (echo "AWS_ACCESS_KEY_ID missing" && exit 1)
          test -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}" || (echo "AWS_SECRET_ACCESS_KEY missing" && exit 1)
          test -n "${{ secrets.SSH_PRIVATE_KEY }}" || (echo "SSH_PRIVATE_KEY missing" && exit 1)
          test -n "${{ secrets.SECURITY_GROUP_ID }}" || (echo "SECURITY_GROUP_ID missing" && exit 1)
          test -n "${{ secrets.PUBLIC_KEY_BASE64 }}" || (echo "PUBLIC_KEY_BASE64 missing" && exit 1)
          echo "All secrets are present!"

      # ──────── TERRAFORM ────────
      - name: Terraform Init
        working-directory: infra/terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          TF_VAR_security_group_id: ${{ secrets.SECURITY_GROUP_ID }}
          TF_VAR_public_key_base64: ${{ secrets.PUBLIC_KEY_BASE64 }}
        run: terraform init -backend=false

      - name: Terraform Plan
        working-directory: infra/terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          TF_VAR_security_group_id: ${{ secrets.SECURITY_GROUP_ID }}
          TF_VAR_public_key_base64: ${{ secrets.PUBLIC_KEY_BASE64 }}
        run: terraform plan -out=plan.tfout

      - name: Terraform Apply
        working-directory: infra/terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          TF_VAR_security_group_id: ${{ secrets.SECURITY_GROUP_ID }}
          TF_VAR_public_key_base64: ${{ secrets.PUBLIC_KEY_BASE64 }}
        run: terraform apply -auto-approve plan.tfout

      # ──────── GET DYNAMIC IP FROM TERRAFORM ────────
      - name: Get EC2 IP from Terraform
        id: tf_output
        working-directory: infra/terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          PUBLIC_IP=$(terraform output -raw public_ip)
          echo "EC2_HOST=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "✓ EC2 Public IP: $PUBLIC_IP"

      # ──────── WAIT FOR EC2 TO BE SSH-READY ────────
      - name: Wait for EC2 instance to be ready for SSH
        env:
          EC2_HOST: ${{ steps.tf_output.outputs.EC2_HOST }}
        run: |
          # Create SSH key first
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > key.pem
          chmod 400 key.pem
          
          echo "Waiting for EC2 instance at $EC2_HOST to be ready for SSH..."
          
          max_attempts=36  # 6 minutes total (36 * 10 seconds)
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts: Checking SSH connectivity..."
            
            # Try SSH connection with timeout
            if timeout 10 ssh -i key.pem \
               -o StrictHostKeyChecking=no \
               -o UserKnownHostsFile=/dev/null \
               -o ConnectTimeout=5 \
               -o BatchMode=yes \
               ec2-user@$EC2_HOST 'echo "SSH Ready"' 2>/dev/null; then
              echo "✓ SSH connection successful! Instance is ready."
              exit 0
            fi
            
            if [ $attempt -eq $max_attempts ]; then
              echo "✗ ERROR: Timeout after 6 minutes waiting for SSH"
              echo "Debug: Attempting one final connection with verbose output..."
              ssh -i key.pem -vvv \
                -o StrictHostKeyChecking=no \
                -o UserKnownHostsFile=/dev/null \
                -o ConnectTimeout=10 \
                ec2-user@$EC2_HOST 'echo test' || true
              exit 1
            fi
            
            echo "Instance not ready yet, waiting 10 seconds..."
            sleep 10
          done

      # ──────── ANSIBLE DEPLOY ────────
      - name: Deploy with Ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: False
          EC2_HOST: ${{ steps.tf_output.outputs.EC2_HOST }}
        run: |
          # SSH key already created in previous step
          
          # === Create inventory using DYNAMIC IP ===
          cat > inventory.ini <<EOF
          [web]
          $EC2_HOST ansible_user=ec2-user ansible_ssh_private_key_file=$(pwd)/key.pem ansible_become=true ansible_remote_tmp=/home/ec2-user/.ansible/tmp
          EOF

          echo "=== INVENTORY ==="
          cat inventory.ini

          # === SET REPO URL ===
          REPO_URL="https://github.com/SamXl-Codes/devops-aws-terraform-ansible-cicd.git"
          echo "Deploying from: $REPO_URL"

          # === Test connectivity first ===
          echo "Testing Ansible connectivity..."
          ansible all -i inventory.ini -m ping --ssh-common-args="-o StrictHostKeyChecking=no"

          # === Run Ansible with verbose output ===
          echo "Running Ansible playbook..."
          ansible-playbook \
            -i inventory.ini \
            config/ansible/deploy_portfolio_flask.yml \
            --ssh-common-args="-o StrictHostKeyChecking=no" \
            -e "repo_url=$REPO_URL" \
            -v

          # === Verify deployment ===
          echo "Verifying deployment..."
          ansible all -i inventory.ini -m shell -a "systemctl status portfolio" --ssh-common-args="-o StrictHostKeyChecking=no" || true
          ansible all -i inventory.ini -m shell -a "systemctl status nginx" --ssh-common-args="-o StrictHostKeyChecking=no" || true
          ansible all -i inventory.ini -m shell -a "curl -s -o /dev/null -w '%{http_code}' http://localhost" --ssh-common-args="-o StrictHostKeyChecking=no" || true

          # === Show success URL ===
          echo ""
          echo "════════════════════════════════════════"
          echo "   ✓ DEPLOYMENT SUCCESSFUL!"
          echo "════════════════════════════════════════"
          echo "Your app is live at:"
          echo " http://$EC2_HOST"
          echo "════════════════════════════════════════"
          echo ""

      # ──────── FINAL CLEANUP ────────
      - name: Final cleanup
        if: always()
        run: |
          rm -f key.pem inventory.ini || true
